<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Accesso</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; padding-top: 100px; background: #1a1a1a; color: white; }
        .box { background: #2a2a2a; padding: 30px; border-radius: 12px; width: 320px; text-align: center; }
        .hidden { display: none; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; border: none; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #e50914; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        a { color: #aaa; font-size: 0.8em; text-decoration: none; display: block; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="box">
        <div id="step-mail">
            <h3>BENVENUTO</h3>
            <input type="email" id="email" placeholder="Email">
            <button onclick="checkEmail()">Continua</button>
        </div>
        <div id="step-login" class="hidden">
            <h3>LOGIN</h3>
            <input type="password" id="login-pass" placeholder="Password">
            <button onclick="login()">Entra</button>
            <a href="#" onclick="showStep('step-reset')">Password dimenticata?</a>
        </div>
        <div id="step-reset" class="hidden">
            <h3>IMPOSTA PASSWORD</h3>
            <input type="password" id="new-pass" placeholder="Nuova Password">
            <input type="password" id="conf-pass" placeholder="Conferma Password">
            <button onclick="updatePassword()">Salva ed Entra</button>
        </div>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbymyNgsOrOWmXh4uJ-DzQ5U324IDHCnhN9_P6suw-Z-9O4tct1Zfw-DG7RG_evbiYXJrQ/exec"; 
        let userEmail = "", securityToken = "";

        function showStep(id) {
            ['step-mail', 'step-login', 'step-reset'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        async function checkEmail() {
            userEmail = document.getElementById('email').value.trim();
            const res = await fetch(`${WEB_APP_URL}?action=subscribe&user_email=${userEmail}`, { method: 'POST' });
            const text = await res.text();
            const [stato, token] = text.split("|");
            securityToken = token;
            showStep(stato === "VAI_A_LOGIN" ? 'step-login' : 'step-reset');
        }

        async function login() {
            const pass = document.getElementById('login-pass').value;
            const res = await fetch(`${WEB_APP_URL}?action=login&user_email=${userEmail}&user_password=${pass}`, { method: 'POST' });
            const text = await res.text();
            if(text.includes("OK")) {
                localStorage.setItem('userStatus', text.split("|")[1]);
                window.location.href = "dashboard.html";
            } else alert("Password errata!");
        }

        async function updatePassword() {
            const p1 = document.getElementById('new-pass').value;
            if(p1 !== document.getElementById('conf-pass').value) return alert("No match");
            const res = await fetch(`${WEB_APP_URL}?action=update&token=${securityToken}&new_password=${p1}`, { method: 'POST' });
            const text = await res.text();
            if(text.includes("OK")) {
                localStorage.setItem('userStatus', text.split("|")[1]);
                window.location.href = "dashboard.html";
            } else alert("Errore");
        }
    </script>
</body>
</html>
